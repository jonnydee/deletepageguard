====== Delete Page Guard Plugin ======

---- plugin ----
description: Prevent deletion of pages by empty saves when page IDs or file paths match configured regular expressions. Only administrators and optionally exempt groups may delete such pages.
author     : Johann Duscher
email      : jonny.dee@posteo.net
type       : action
lastupdate : 2025-11-02
compatible : Librarian
depends    : 
conflicts  : 
similar    : 
tags       : protection, security, admin, pages, deletion

downloadurl: https://github.com/jonnydee/deletepageguard/releases/download/v1.0.0/deletepageguard-1.0.0.zip
bugtracker : https://github.com/jonnydee/deletepageguard/issues
sourcerepo : https://github.com/jonnydee/deletepageguard
donationurl: 

screenshot_img : 
----

===== Description =====

The **Delete Page Guard** plugin prevents accidental or intentional deletion of wiki pages in your DokuWiki installation by blocking the "empty save" operation when certain pages are protected. A page is considered for protection when its ID or relative file path matches one or more regular expressions configured via the DokuWiki Configuration Manager.

===== Features =====

  * Prevents deletion via "empty save" on protected pages
  * Supports any number of protection patterns using PCRE syntax
  * Choose whether to match against the colon-separated page ID or the relative file system path
  * Allow administrators and optional additional groups to bypass the protection
  * Optionally treat whitespace-only content as empty
  * **Pattern validation**: Real-time validation with detailed error messages for administrators
  * **Admin interface**: Dedicated admin page for testing and validating patterns
  * **Security features**: Built-in ReDoS protection and input sanitization

===== Installation =====

Install the plugin using the [[plugin:extension|Extension Manager]] and the download URL above, which points to the latest version. Or download the package manually and extract it into your DokuWiki's ''lib/plugins/'' directory.

After installation, visit the **Configuration Manager** in your DokuWiki admin panel and adjust the plugin settings under the "Delete Page Guard" section.

===== Configuration =====

The following options are available in the Configuration Manager:

^ Setting ^ Description ^
| **Protected page patterns** | List of PCRE regular expressions. Each line defines a pattern. When a page matches any pattern, non-admin users cannot delete it by empty save. Invalid patterns are automatically skipped with warnings shown to administrators. |
| **Match against** | Choose whether the patterns should match against the page ID (e.g. ''users:john:home'') or the relative file path (e.g. ''users/john/home.txt''). |
| **Extra groups allowed to delete** | Comma separated list of user groups that are allowed to delete protected pages, in addition to administrators. Leave empty to restrict deletion to admins only. |
| **Treat whitespace-only pages as empty** | If enabled, pages containing only whitespace will be treated as empty and deletion will be blocked on protected pages. |

==== Pattern Examples ====

  * ''%%^users:%%'' – protect all pages in the ''users'' namespace
  * ''%%^users:[^:]+:start$%%'' – protect every user's landing page named ''start'' under ''users:<username>''
  * ''%%^projects:.*$%%'' – protect everything in the ''projects'' namespace
  * ''%%^private/.*\.txt$%%'' – when matching against file paths, protect any ''.txt'' file in the ''private'' directory

===== Pattern Validation =====

The plugin includes comprehensive pattern validation:

  * **Real-time validation**: Invalid patterns are automatically detected when pages are saved
  * **Administrator feedback**: Detailed error messages are shown to administrators when invalid patterns are encountered
  * **Admin interface**: Visit **Admin → Delete Page Guard** to test and validate patterns before saving them to configuration
  * **Security protection**: Built-in protection against ReDoS (Regular Expression Denial of Service) attacks

===== How It Works =====

When a page is saved, DokuWiki triggers the ''COMMON_WIKIPAGE_SAVE'' event just before writing to disk. For normal edits, the plugin does nothing. However, when the new content is empty (after optional trimming) the plugin checks the configured patterns against the chosen target (ID or file path). If a match occurs and the current user is not an administrator and not in one of the exempt groups, the plugin prevents the deletion and displays an error message.

===== Development =====

The plugin includes a comprehensive test suite for developers:

<code bash>
# Run all tests
php tests/test_runner.php

# Check syntax of all files
make check

# See all available commands
make help
</code>

The test suite includes 32 comprehensive tests covering pattern validation, matching logic, security features, and edge cases without requiring a DokuWiki installation.

For maintainers and contributors, see the [[https://github.com/jonnydee/deletepageguard/blob/master/RELEASE.md|RELEASE.md]] file for the complete release workflow.

===== Compatibility =====

This plugin has been tested with **DokuWiki "Librarian" (2025-05-14b)**.

It hooks into the ''COMMON_WIKIPAGE_SAVE'' event, which was introduced in DokuWiki release **"Detritus" (2016-02-24)** and is marked as preventable. The plugin uses only stable, public APIs and the documented event system that have been available since "Detritus", so it should work with most recent DokuWiki versions. Please report any compatibility issues on GitHub.

===== Changelog =====

See [[https://github.com/jonnydee/deletepageguard/blob/master/CHANGELOG.md|CHANGELOG.md]] for detailed release notes.

  * **2025-11-02**
    * Initial release v1.0.0
    * Core deletion prevention functionality
    * Pattern validation with ReDoS protection
    * Admin interface for testing patterns
    * Comprehensive test suite (32 tests)

===== License =====

This plugin is released under the [[https://www.gnu.org/licenses/gpl-2.0.html|GNU General Public License v2]].

===== Support =====

  * **Bug Reports**: [[https://github.com/jonnydee/deletepageguard/issues|GitHub Issues]]
  * **Source Code**: [[https://github.com/jonnydee/deletepageguard|GitHub Repository]]
  * **Discussion**: Use the discussion section below
